.PHONY: all clean clobber

#export SBT_OPTS="-Xmx2G -Xms1G"

TESTS_DIR := ../tests
TEST_CLASS_FILES := $(wildcard $(TESTS_DIR)/*.java)
TEST_CLASS_NAMES := $(basename $(notdir $(TEST_CLASS_FILES)))

FUNSUMDOT = $(wildcard funsum_*.dot)
FUNSUMPDF = $(FUNSUMDOT:.dot=.pdf)

# DEPS := $(wildcard *.scala) $(wildcard ../shared/*.scala)

# publish: $(DEPS)
# 	sbt publishLocal

publish:
	sbt publishLocal

all: $(FUNSUMPDF)

funsum_%.pdf: funsum_%.dot
	# dot -Tpdf "$<" -o "$@" # -Tpdf only does one graph
	# dot -Tps2 "$<" -o "$(@:.dot=.ps)" | ps2pdf "$(@:.dot=.ps)"  # gets cut off
	dot -Tps "$<" -o "$@"  # weird but it works

clean:
	rm -rf $(wildcard funsum_*.pdf)

clobber:
	rm -rf $(wildcard funsum_*.pdf) $(wildcard funsum_*.dot)

doc: README.md
	markdown README.md > README.html

%.class: %.java
	javac -g $<

tests: $(TEST_CLASS_FILES)
	javac -g $(TEST_CLASS_FILES)

print-%: ; @echo $*=$($*)
-include .tests

AINTERP_OPTS := -E./e1_externals.txt
testindex: $(TEST_CLASS_FILES)
	@echo "# This file was automatically generated by \"make testindex\"." > .tests
	@echo "SC := \;" >> .tests 
	@echo "C := \:" >> .tests
	@for cname in $(TEST_CLASS_NAMES) ; do \
		echo "Generating Makefile entries for tests in $$cname" ; \
		temp=$$(./ainterp -E./e1_externals.txt -D$(TESTS_DIR) -S"$$cname\\\\..*" --list-entries) ; \
		for tname in $$temp ; do \
			tname_temp1=`echo $$tname | sed s/\:/\$$\(C\)/g` ; \
			tname_temp2=`echo $$tname_temp1 | sed s/\;/\$$\(SC\)/g` ; \
			echo "$$tname_temp2: $(TESTS_DIR)/$$cname.class" >> .tests ; \
			echo "\t./ainterp $(AINTERP_OPTS) -D$(TESTS_DIR) -S$$cname.\* \"$$tname\"" >> .tests ; \
		done \
	done
